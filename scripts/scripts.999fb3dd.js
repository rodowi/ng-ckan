"use strict";angular.module("ngCkanApp",["ngCookies","ngResource","ngRoute","ngSanitize","ngTouch","ui.bootstrap.pagination"]).config(["$routeProvider",function(a){a.when("/",{redirectTo:"/conjuntos"}).when("/conjuntos",{templateUrl:"views/datasets.html",controller:"DatasetsCtrl",reloadOnSearch:!1}).when("/conjuntos/:datasetId",{templateUrl:"views/resources.html",controller:"ResourcesCtrl"}).when("/instituciones",{templateUrl:"views/organizations.html",controller:"OrganizationsCtrl",reloadOnSearch:!1}).when("/instituciones/:organizationId",{templateUrl:"views/organization.html",controller:"OrganizationCtrl"}).when("/grupos",{templateUrl:"views/groups.html",controller:"GroupsCtrl"}).when("/grupos/:groupId",{templateUrl:"views/group.html",controller:"GroupCtrl"}).otherwise({redirectTo:"/"})}]),angular.module("ngCkanApp").controller("DatasetsCtrl",["$scope","$location","ckanService",function(a,b,c){var d="",e=b.search(),f=e.page?e.page:1,g=function(){a.searching=!0,c.listDatasets((f-1)*a.limit,d,a.order).then(function(b){a.datasets=b.datasets,a.resultsCount=b.resultsCount,a.totalItems=b.resultsCount-a.limit,a.page=f,a.searching=!1})},h=function(b){var c=b.charAt(0).toUpperCase()+b.slice(1);d+="Autonomos"==c?"+organization:(inegi OR ift)":"+vocab_gov_types:("+c+")",a.gov=c};e.gob&&h(e.gob),a.limit=e.limit?e.limit:10,a.order=e.sort?e.sort:"",a.search=function(){a.keyword?b.search("search",encodeURIComponent(a.keyword)):b.search("search",null)},a.sort=function(){a.order?b.search("sort",a.order):b.search("sort",null)},a.clearGov=function(){b.search("gob",null),a.gov=""},a.paginate=function(){a.page>1?b.search("page",a.page):b.search("page",null),f=a.page},a.$on("$routeUpdate",function(b,c){if(d="",c.params.gob&&h(c.params.gob),c.params.search){var e=decodeURIComponent(c.params.search);a.keyword=e;var f=e.split(" ").join("* OR ");e=e.split(" ").join(" OR "),d+="title:("+e+" OR "+f+"*)"}g()}),g()}]),angular.module("ngCkanApp").controller("ResourcesCtrl",["$scope","$routeParams","ckanService",function(a,b,c){var d=b.datasetId.replace(/_/g,"-"),e=!1,f=function(b){c.showDataset(b).then(function(b){a.dataset=b},function(a){e||(e=!0,b=b.replace(/--/g,"-"),f(b))})};f(d)}]),angular.module("ngCkanApp").controller("OrganizationsCtrl",["$scope","$location","ckanService",function(a,b,c){var d="",e=b.search(),f=function(){a.searching=!0,c.listOrganizations(a.order).then(function(b){a.organizations=b,a.organizations_displayed=b.length,a.searching=!1,e.gob&&(d=e.gob,g(e.gob))})},g=function(b){for(var c=a.organizations.length,d=0;d<a.organizations.length;d++)switch(a.organizations[d].hide=!1,b){case"autonomos":"inegi"!=a.organizations[d].name&&"ift"!=a.organizations[d].name&&(c--,a.organizations[d].hide=!0);break;case"federal":("inegi"==a.organizations[d].name||"ift"==a.organizations[d].name||/estado-de.*/.test(a.organizations[d].name)||/ayuntamiento-de.*/.test(a.organizations[d].name))&&(c--,a.organizations[d].hide=!0);break;case"estatal":/estado-de.*/.test(a.organizations[d].name)||(c--,a.organizations[d].hide=!0);break;case"municipal":/ayuntamiento-de.*/.test(a.organizations[d].name)||(c--,a.organizations[d].hide=!0);break;default:a.organizations[d].hide=!1}b=b.charAt(0).toUpperCase()+b.slice(1),a.gov=b,a.organizations_displayed=c};a.order=e.sort?e.sort:"",a.sort=function(){a.order?b.search("sort",a.order):b.search("sort",null)},a.clearGov=function(){b.search("gob",null),g("")},a.$on("$routeUpdate",function(a,b){b.params.gob&&b.params.gob!=d?(d=b.params.gob,g(b.params.gob)):f()}),f()}]),angular.module("ngCkanApp").controller("OrganizationCtrl",["$scope","$routeParams","ckanService",function(a,b,c){c.showOrganization(b.organizationId).then(function(b){a.organization=b})}]),angular.module("ngCkanApp").controller("GroupsCtrl",["$scope","$location","ckanService",function(a,b,c){var d=b.search(),e=function(){a.searching=!0,c.listGroups(a.order).then(function(b){a.groups=b,a.searching=!1})};a.order=d.sort?d.sort:"",a.sort=function(){a.order?b.search("sort",a.order):b.search("sort",null)},e()}]),angular.module("ngCkanApp").controller("GroupCtrl",["$scope","$routeParams","ckanService",function(a,b,c){c.showGroup(b.groupId).then(function(b){a.group=b})}]),angular.module("ngCkanApp").service("ckanService",["$http",function(a){var b="http://catalogo.datos.gob.mx/api/3/action/";this.countDatasets=function(c){return c||(c=""),a.get(b+"package_search?q="+c+"&rows=0").then(function(a){return a.data.result})},this.listDatasets=function(c,d,e){return d||(d=""),e=e?"&sort="+e:"",a.get(b+"package_search?q="+d+"&rows=10&start="+c+e).then(function(a){var b=a.data.result.count,c=a.data.result.results;return{datasets:c,resultsCount:b}})},this.showDataset=function(c){return a.get(b+"package_show?id="+c).then(function(a){return a.data.result})},this.listOrganizations=function(c){return c=c?"&sort="+c:"",a.get(b+"organization_list?all_fields=true"+c).then(function(a){return a.data.result})},this.showOrganization=function(c){return a.get(b+"organization_show?id="+c).then(function(a){return a.data.result})},this.listGroups=function(c){return c=c?"&sort="+c:"",a.get(b+"group_list?all_fields=true"+c).then(function(a){return a.data.result})},this.showGroup=function(c){return a.get(b+"group_show?id="+c).then(function(a){return a.data.result})}}]),angular.module("ngCkanApp").directive("govTypesMenu",["$location","ckanService",function(a,b){return{templateUrl:"views/gov-types-menu.html",restrict:"E",scope:{organizations:"@organizations"},link:function(c,d,e){var f="",g="",h=a.search(),i=a.path(),j=h.page?h.page:1,k=h.sort?h.sort:"",l=function(){var a=!0,d=!0,e=!0,h=!0;switch(g){case"autonomos":c.gov_state=0,c.gov_municipal=0,c.gov_federal=0,a=!1,d=!1,e=!1;break;case"federal":c.gov_state=0,c.gov_municipal=0,c.gov_autonomous=0,h=!1,d=!1,e=!1;break;case"estatal":c.gov_federal=0,c.gov_municipal=0,c.gov_autonomous=0,h=!1,a=!1,e=!1;break;case"municipal":c.gov_federal=0,c.gov_state=0,c.gov_autonomous=0,h=!1,a=!1,d=!1}h&&b.countDatasets(f+"+organization:(inegi OR ift)").then(function(a){c.gov_autonomous=a.count}),a&&b.countDatasets(f+"+vocab_gov_types:Federal").then(function(a){c.gov_federal=a.count}),d&&b.countDatasets(f+"+vocab_gov_types:Estatal").then(function(a){c.gov_state=a.count}),e&&b.countDatasets(f+"+vocab_gov_types:Municipal").then(function(a){c.gov_municipal=a.count})},m=function(){c.$watch("organizations",function(a){c.numbers=!0;for(var b=0,d=0,e=0,f=0,h=a?angular.fromJson(a):[],i=0;i<h.length;i++)"inegi"==h[i].name||"ift"==h[i].name?b++:/estado-de.*/.test(h[i].name)?e++:/ayuntamiento-de.*/.test(h[i].name)?f++:d++;switch(c.gov_autonomous=!1,c.gov_federal=!1,c.gov_state=!1,c.gov_municipal=!1,g){case"autonomos":c.gov_autonomous=b;break;case"federal":c.gov_federal=d;break;case"estatal":c.gov_state=e;break;case"municipal":c.gov_municipal=f;break;default:c.gov_autonomous=b,c.gov_federal=d,c.gov_state=e,c.gov_municipal=f}})},n=function(){"/instituciones"==i?m():l()};h.gob&&(g=h.gob),c.numbers=!1,c.$on("$routeUpdate",function(b,c){h=a.search(),f="";var d=h.page?h.page:1,e=h.sort?h.sort:"";if(j!=d)return void(j=d);if(k!=e)return void(k=e);if(c.params.search){var h=decodeURIComponent(c.params.search),i=h.split(" ").join("* OR ");h=h.split(" ").join(" OR "),f="title:("+h+" OR "+i+"*)"}g=c.params.gob?c.params.gob:"",n()}),c.filter=function(b,c){b.preventDefault(),a.search("gob",c)},n()}}}]),angular.module("ngCkanApp").filter("formats",function(){return function(a){var b=_.pluck(a.resources,"format");return _.uniq(b)}}),angular.module("ngCkanApp").filter("capitalize",function(){return function(a){return a?a.charAt(0).toUpperCase()+a.substr(1).toLowerCase():""}});